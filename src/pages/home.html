<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../styles/home.css">
</head>
<body>
<h1>Hello world</h1>
<div class="tooltip">
    <div id="my-invitation">
        <button class="invite-button" onclick="startGame()" id="take_invite">"Принять приглашение"</button>
    </div>
    <div id="invite">
        <button class="invite-button" onclick="inviteToGame()">Пригласить в игру</button>
   </div>

</div>
</body>

<script>

    let current_user_id = null
    let inviting_user_id = null

    function startGame(){

        fetch("http://localhost:8000/creategroup", {
            method: "POST",
            body: JSON.stringify(
                {
                    "owner_id": '',
                    "guest_id": current_user_id
                }
            ),
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        })
            .then((response) => console.log(response))

    }

    fetch("http://localhost:8000/users", {headers: {
            Authorization: 'Bearer ' + localStorage.token
        }})
        .then((response) => response.json()).
        //response.ok ? setError('Успешная регистрация') : setError('Ошибка регистрации'), response.json()).
        then(function(result){ current_user_id = result.current_user_id; return result}).
        then(function(result){createList(result.users); console.log(result.users); return result})


    // console.log(current_user_id)

    const chatSocket = new WebSocket(`ws://localhost:8000/home`)

    chatSocket.onopen = function(e){
        console.log("connected")
    }

    chatSocket.onmessage = function(event) {

        const data = JSON.parse(event.data);
        console.log(data)
        if(data.type === 'invite' && data.user_id == current_user_id){
           let my_invitation = document.getElementById('my-invitation')
           let take_invite_button = document.getElementById('take_invite')
           take_invite_button.style.display = "block"
           let anons = document.createElement('h3')
           let inviting_user_id = data.inviting_user_id
           anons.innerHTML = `${data.inviting_username} приглашает вас в игру`
           my_invitation.appendChild(invite_button)
           my_invitation.appendChild(anons)

        }

    }

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    // var enemies = [1]


    function createList(enemies) {
        let filtred_enemies = []

        for(let i = 0; i < enemies.length; i++){
            if(enemies[i].user_id !== current_user_id){
                filtred_enemies.unshift(enemies[i])
            }
        }
        console.log(filtred_enemies)
        let invitelist = document.getElementById('invite')
        let selectEnemy = document.createElement('select')
        selectEnemy.id = "selectEnemy"
        selectEnemy.size = filtred_enemies.length

        for (var i = 0; i < filtred_enemies.length; i++) {
            var option = document.createElement("option");
            option.value = filtred_enemies[i]['user_id'];
            option.text = `${filtred_enemies[i]['first_name']} ${filtred_enemies[i]['last_name']}`;
            option.className = "option"
            selectEnemy.appendChild(option);
        }
        invitelist.appendChild(selectEnemy)
    }

    function inviteToGame(){
        let player_to_invite = document.getElementById("selectEnemy").value

        chatSocket.send(JSON.stringify({
            'type':"invite",
            'user_id': player_to_invite,
            'inviting_user_id': current_user_id
            }))
    }


</script>
</html>